<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>リフォームローンシミュレーション | 簡単試算</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #a5b4fc;
            --secondary: #f0f9ff;
            --accent: #f43f5e;
            --success: #10b981;
            --warning: #f59e0b;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --bg-card: #ffffff;
            --bg-hover: #f8fafc;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 40px rgba(0,0,0,0.15);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Helvetica Neue', 'Noto Sans JP', -apple-system, sans-serif;
            background: linear-gradient(180deg, #e0e7ff 0%, #f0f9ff 100%);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* コンテナ */
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ヘッダー */
        .app-header {
            text-align: center;
            padding: 40px 20px;
            margin-bottom: 40px;
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .app-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 50%, var(--primary) 100%);
            animation: gradient-move 3s ease infinite;
        }

        @keyframes gradient-move {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .header-icon {
            display: inline-block;
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin: 0 auto 20px;
            box-shadow: var(--shadow-lg);
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .app-title {
            font-size: clamp(24px, 4vw, 36px);
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 10px;
            letter-spacing: -0.5px;
        }

        .app-subtitle {
            font-size: clamp(14px, 2vw, 18px);
            color: var(--text-secondary);
            font-weight: 400;
        }

        /* メインコンテンツ */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 30px;
            margin-bottom: 40px;
        }

        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* カード共通スタイル */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: 30px;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-xl);
            transform: translateY(-2px);
        }

        /* フォームカード */
        .form-card {
            position: relative;
        }

        .form-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .form-icon {
            width: 36px;
            height: 36px;
            background: var(--primary-light);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .form-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            flex: 1;
        }

        /* フォームグループ */
        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .required-badge {
            background: var(--accent);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
        }

        .help-icon {
            width: 18px;
            height: 18px;
            background: var(--text-muted);
            color: white;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            cursor: help;
            position: relative;
        }

        .help-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-primary);
            color: white;
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
            margin-bottom: 5px;
        }

        .help-icon:hover .help-tooltip {
            opacity: 1;
        }

        .input-group {
            position: relative;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 16px;
            font-family: inherit;
            transition: var(--transition);
            background: white;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .input-suffix {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 600;
            pointer-events: none;
        }

        /* スライダー入力 */
        .slider-container {
            margin-top: 12px;
        }

        .slider {
            width: 100%;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: var(--primary-dark);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            border: none;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-muted);
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 20px;
            height: fit-content;
        }

        .progress-card {
            margin-bottom: 20px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .progress-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .progress-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
        }

        .progress-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 4px;
            transition: width 0.6s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* 計算ボタン */
        .calculate-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 14px rgba(99, 102, 241, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calculate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .calculate-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .calculate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-icon {
            font-size: 20px;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 結果セクション */
        .results-section {
            display: none;
            animation: fadeInUp 0.6s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .results-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .results-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .result-item {
            background: white;
            border-radius: var(--radius-md);
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .result-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-light);
        }

        .result-item.primary {
            background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%);
            border-color: var(--warning);
        }

        .result-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .result-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary-dark);
            margin-bottom: 4px;
        }

        .result-item.primary .result-value {
            font-size: 28px;
            color: var(--accent);
        }

        .result-change {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .change-up {
            background: rgba(244, 63, 94, 0.1);
            color: var(--accent);
        }

        .change-down {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .change-none {
            background: var(--bg-hover);
            color: var(--text-muted);
        }

        /* テーブル表示 */
        .schedule-section {
            margin-top: 30px;
        }

        .toggle-schedule-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 0 auto 20px;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .toggle-schedule-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .schedule-table-wrapper {
            display: none;
            overflow-x: auto;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .schedule-table {
            width: 100%;
            background: white;
            border-collapse: collapse;
        }

        .schedule-table th {
            background: var(--primary);
            color: white;
            padding: 12px;
            text-align: left;
            font-size: 14px;
            font-weight: 600;
        }

        .schedule-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        .schedule-table tr:hover td {
            background: var(--bg-hover);
        }

        /* ヒントカード */
        .tips-section {
            margin-top: 40px;
        }

        .tips-card {
            background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%);
            border: 2px solid var(--primary-light);
            padding: 30px;
        }

        .tips-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .tips-icon {
            font-size: 32px;
        }

        .tips-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .tips-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .tip-item {
            background: white;
            padding: 16px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }

        .tip-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .tip-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 8px;
        }

        .tip-text {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* フローティングボタン */
        .floating-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
            transition: var(--transition);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .floating-btn:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 6px 30px rgba(99, 102, 241, 0.4);
        }

        /* モーダル */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-xl);
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 30px 30px 20px;
            border-bottom: 2px solid var(--border);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-body {
            padding: 30px;
            line-height: 1.8;
        }

        .modal-close {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: var(--primary-dark);
        }

        /* レスポンシブ */
        @media (max-width: 768px) {
            .app-container {
                padding: 10px;
            }

            .card {
                padding: 20px;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }

            .tips-grid {
                grid-template-columns: 1fr;
            }

            .floating-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
                bottom: 20px;
                right: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ヘッダー -->
        <header class="app-header">
            <div class="header-icon">🏠</div>
            <h1 class="app-title">リフォームローンシミュレーション</h1>
            <p class="app-subtitle">簡単3ステップで月々の返済額を試算</p>
        </header>

        <!-- メインコンテンツ -->
        <div class="main-content">
            <!-- フォームエリア -->
            <div class="form-area">
                <form id="loanForm">
                    <!-- 基本条件 -->
                    <div class="card form-card">
                        <div class="form-header">
                            <div class="form-icon">📊</div>
                            <h2 class="form-title">基本条件</h2>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                借入希望額
                                <span class="required-badge">必須</span>
                                <span class="help-icon">
                                    ?
                                    <span class="help-tooltip">10万円〜1,500万円の範囲で入力</span>
                                </span>
                            </label>
                            <div class="input-group">
                                <input type="number" 
                                       class="form-input" 
                                       id="loanAmount" 
                                       min="10" 
                                       max="1500" 
                                       value="300" 
                                       required>
                                <span class="input-suffix">万円</span>
                            </div>
                            <div class="slider-container">
                                <input type="range" 
                                       class="slider" 
                                       id="loanAmountSlider" 
                                       min="10" 
                                       max="1500" 
                                       value="300">
                                <div class="slider-labels">
                                    <span>10万円</span>
                                    <span id="loanAmountDisplay">300万円</span>
                                    <span>1,500万円</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                返済期間
                                <span class="required-badge">必須</span>
                            </label>
                            <select class="form-select" id="loanPeriod" required>
                                <option value="">選択してください</option>
                                <option value="1">1年</option>
                                <option value="2">2年</option>
                                <option value="3">3年</option>
                                <option value="5">5年</option>
                                <option value="7">7年</option>
                                <option value="10" selected>10年</option>
                                <option value="15">15年</option>
                                <option value="20">20年</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                金利（年率）
                                <span class="required-badge">必須</span>
                                <span class="help-icon">
                                    ?
                                    <span class="help-tooltip">一般的に2〜4%程度</span>
                                </span>
                            </label>
                            <div class="input-group">
                                <input type="number" 
                                       class="form-input" 
                                       id="interestRate" 
                                       min="0.1" 
                                       max="15" 
                                       step="0.01" 
                                       value="2.8" 
                                       required>
                                <span class="input-suffix">%</span>
                            </div>
                            <div class="slider-container">
                                <input type="range" 
                                       class="slider" 
                                       id="interestRateSlider" 
                                       min="0.1" 
                                       max="15" 
                                       step="0.1" 
                                       value="2.8">
                                <div class="slider-labels">
                                    <span>0.1%</span>
                                    <span id="interestRateDisplay">2.8%</span>
                                    <span>15%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 詳細設定 -->
                    <div class="card form-card" style="margin-top: 20px;">
                        <div class="form-header">
                            <div class="form-icon">⚙️</div>
                            <h2 class="form-title">詳細設定</h2>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                返済方法
                                <span class="help-icon">
                                    ?
                                    <span class="help-tooltip" style="width: 250px;">元利均等：毎月一定額、元金均等：元金が一定</span>
                                </span>
                            </label>
                            <select class="form-select" id="paymentType">
                                <option value="equal">元利均等返済</option>
                                <option value="principal">元金均等返済</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">ボーナス返済割合</label>
                            <select class="form-select" id="bonusRatio">
                                <option value="0">なし</option>
                                <option value="10">10%</option>
                                <option value="20">20%</option>
                                <option value="30">30%</option>
                                <option value="40">40%</option>
                                <option value="50">50%</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>

            <!-- サイドバー -->
            <aside class="sidebar">
                <!-- 進捗カード -->
                <div class="card progress-card">
                    <div class="progress-header">
                        <span class="progress-title">入力完了度</span>
                        <span class="progress-value" id="progressValue">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                    </div>
                </div>

                <!-- 計算ボタン -->
                <button class="calculate-btn" id="calculateBtn" onclick="calculateLoan()">
                    <span class="btn-icon">📱</span>
                    <span>シミュレーション実行</span>
                </button>

                <!-- クイックヒント -->
                <div class="card" style="margin-top: 20px;">
                    <h3 style="font-size: 16px; margin-bottom: 12px; color: var(--text-primary);">💡 クイックヒント</h3>
                    <p style="font-size: 14px; color: var(--text-secondary); line-height: 1.6;">
                        スライダーを使って金額や金利を調整できます。前回の計算結果との比較も自動表示されます。
                    </p>
                </div>
            </aside>
        </div>

        <!-- 結果セクション -->
        <div class="results-section" id="resultsSection">
            <div class="card">
                <div class="results-header">
                    <h2 class="results-title">📊 シミュレーション結果</h2>
                </div>

                <div class="results-grid">
                    <div class="result-item primary">
                        <div class="result-label">毎月の返済額</div>
                        <div class="result-value" id="monthlyPayment">-</div>
                        <div class="result-change change-none" id="monthlyChange">初回計算</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">ボーナス時加算</div>
                        <div class="result-value" id="bonusPayment">-</div>
                        <div class="result-change change-none" id="bonusChange">-</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">年間返済額</div>
                        <div class="result-value" id="annualPayment">-</div>
                        <div class="result-change change-none" id="annualChange">-</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">総返済額</div>
                        <div class="result-value" id="totalPayment">-</div>
                        <div class="result-change change-none" id="totalChange">-</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">利息総額</div>
                        <div class="result-value" id="totalInterest">-</div>
                        <div class="result-change change-none" id="interestChange">-</div>
                    </div>
                </div>

                <!-- 返済スケジュール -->
                <div class="schedule-section">
                    <button class="toggle-schedule-btn" onclick="toggleSchedule()">
                        <span>📅</span>
                        <span id="scheduleToggleText">返済スケジュールを表示</span>
                    </button>

                    <div class="schedule-table-wrapper" id="scheduleWrapper">
                        <table class="schedule-table">
                            <thead>
                                <tr>
                                    <th>回数</th>
                                    <th>返済額</th>
                                    <th>元金</th>
                                    <th>利息</th>
                                    <th>残高</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ヒントセクション -->
        <div class="tips-section">
            <div class="card tips-card">
                <div class="tips-header">
                    <span class="tips-icon">💡</span>
                    <h2 class="tips-title">賢いリフォームローン活用術</h2>
                </div>
                <div class="tips-grid">
                    <div class="tip-item">
                        <div class="tip-title">
                            <span>🏦</span>
                            <span>金利の比較検討</span>
                        </div>
                        <div class="tip-text">
                            複数の金融機関で見積もりを取り、最も有利な条件を選びましょう
                        </div>
                    </div>
                    <div class="tip-item">
                        <div class="tip-title">
                            <span>⏰</span>
                            <span>返済期間の最適化</span>
                        </div>
                        <div class="tip-text">
                            月々の負担と総利息のバランスを考慮して期間を設定しましょう
                        </div>
                    </div>
                    <div class="tip-item">
                        <div class="tip-title">
                            <span>💰</span>
                            <span>ボーナス返済の活用</span>
                        </div>
                        <div class="tip-text">
                            安定した収入がある場合は、返済期間の短縮に効果的です
                        </div>
                    </div>
                    <div class="tip-item">
                        <div class="tip-title">
                            <span>📈</span>
                            <span>繰上返済の検討</span>
                        </div>
                        <div class="tip-text">
                            余裕がある時は繰上返済で総利息を大幅に削減できます
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- フローティングボタン -->
    <button class="floating-btn" onclick="showHelp()">?</button>

    <!-- ヘルプモーダル -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span>📖</span>
                    <span>使い方ガイド</span>
                </h2>
            </div>
            <div class="modal-body">
                <h3 style="margin-bottom: 12px; color: var(--primary);">基本的な使い方</h3>
                <ol style="margin-bottom: 24px; padding-left: 20px;">
                    <li><strong>借入希望額</strong>：10万円〜1,500万円の範囲で入力します</li>
                    <li><strong>返済期間</strong>：1年〜20年から選択します</li>
                    <li><strong>金利</strong>：年率を％単位で入力（一般的に2〜4%）</li>
                    <li><strong>シミュレーション実行</strong>ボタンをクリック</li>
                </ol>

                <h3 style="margin-bottom: 12px; color: var(--primary);">便利な機能</h3>
                <ul style="margin-bottom: 24px; padding-left: 20px;">
                    <li>スライダーで金額や金利を直感的に調整</li>
                    <li>前回の計算結果との自動比較表示</li>
                    <li>返済スケジュール表で詳細を確認</li>
                    <li>リアルタイムで入力完了度を表示</li>
                </ul>

                <h3 style="margin-bottom: 12px; color: var(--primary);">返済方法について</h3>
                <p style="margin-bottom: 12px;"><strong>元利均等返済</strong>：毎月の返済額が一定。家計管理がしやすい</p>
                <p><strong>元金均等返済</strong>：毎月の元金返済額が一定。総利息が少なくなる</p>

                <button class="modal-close" onclick="closeHelp()">閉じる</button>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let lastCalculation = null;
        let isCalculating = false;

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateProgress();
        });

        // イベントリスナーの設定
        function setupEventListeners() {
            // 借入額スライダー
            const loanAmountInput = document.getElementById('loanAmount');
            const loanAmountSlider = document.getElementById('loanAmountSlider');
            const loanAmountDisplay = document.getElementById('loanAmountDisplay');

            loanAmountSlider.addEventListener('input', function() {
                loanAmountInput.value = this.value;
                loanAmountDisplay.textContent = `${formatNumber(this.value)}万円`;
                updateProgress();
            });

            loanAmountInput.addEventListener('input', function() {
                const value = Math.min(1500, Math.max(10, this.value));
                loanAmountSlider.value = value;
                loanAmountDisplay.textContent = `${formatNumber(value)}万円`;
                updateProgress();
            });

            // 金利スライダー
            const interestRateInput = document.getElementById('interestRate');
            const interestRateSlider = document.getElementById('interestRateSlider');
            const interestRateDisplay = document.getElementById('interestRateDisplay');

            interestRateSlider.addEventListener('input', function() {
                interestRateInput.value = this.value;
                interestRateDisplay.textContent = `${this.value}%`;
                updateProgress();
            });

            interestRateInput.addEventListener('input', function() {
                const value = Math.min(15, Math.max(0.1, this.value));
                interestRateSlider.value = value;
                interestRateDisplay.textContent = `${value}%`;
                updateProgress();
            });

            // その他のフォーム要素
            document.querySelectorAll('select').forEach(select => {
                select.addEventListener('change', updateProgress);
            });

            // キーボードショートカット
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    calculateLoan();
                }
                if (e.key === 'Escape') {
                    closeHelp();
                }
            });
        }

        // 進捗更新
        function updateProgress() {
            const required = ['loanAmount', 'loanPeriod', 'interestRate'];
            let filled = 0;

            required.forEach(id => {
                const element = document.getElementById(id);
                if (element && element.value && element.value !== '') {
                    filled++;
                }
            });

            const percentage = Math.round((filled / required.length) * 100);
            document.getElementById('progressValue').textContent = `${percentage}%`;
            document.getElementById('progressFill').style.width = `${percentage}%`;

            // ボタンの有効/無効
            const calculateBtn = document.getElementById('calculateBtn');
            if (percentage === 100) {
                calculateBtn.disabled = false;
            } else {
                calculateBtn.disabled = true;
            }
        }

        // ローン計算
        function calculateLoan() {
            if (isCalculating) return;

            const loanAmount = parseFloat(document.getElementById('loanAmount').value);
            const loanPeriod = parseInt(document.getElementById('loanPeriod').value);
            const interestRate = parseFloat(document.getElementById('interestRate').value);
            const paymentType = document.getElementById('paymentType').value;
            const bonusRatio = parseFloat(document.getElementById('bonusRatio').value) / 100;

            if (!loanAmount || !loanPeriod || !interestRate) {
                alert('必須項目をすべて入力してください');
                return;
            }

            // ローディング状態
            isCalculating = true;
            const btn = document.getElementById('calculateBtn');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<span class="spinner"></span><span>計算中...</span>';
            btn.disabled = true;

            setTimeout(() => {
                // 計算実行
                const result = performCalculation(
                    loanAmount * 10000,
                    loanPeriod,
                    interestRate / 100,
                    paymentType,
                    bonusRatio
                );

                // 結果表示
                displayResults(result);
                
                // 前回との比較
                if (lastCalculation) {
                    showComparison(lastCalculation, result);
                }
                lastCalculation = result;

                // スケジュール生成
                generateSchedule(result);

                // 結果セクション表示
                const resultsSection = document.getElementById('resultsSection');
                resultsSection.style.display = 'block';
                resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

                // ローディング状態解除
                btn.innerHTML = originalContent;
                btn.disabled = false;
                isCalculating = false;
            }, 500);
        }

        // 計算ロジック
        function performCalculation(principal, years, annualRate, paymentType, bonusRatio) {
            const monthlyRate = annualRate / 12;
            const totalMonths = years * 12;
            const bonusPrincipal = principal * bonusRatio;
            const monthlyPrincipal = principal - bonusPrincipal;

            let monthlyPayment = 0;
            let bonusPayment = 0;
            let totalPayment = 0;
            let schedule = [];

            if (paymentType === 'equal') {
                // 元利均等返済
                if (monthlyRate > 0) {
                    if (monthlyPrincipal > 0) {
                        const r = monthlyRate;
                        const n = totalMonths;
                        monthlyPayment = (monthlyPrincipal * r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
                    }
                    if (bonusPrincipal > 0) {
                        const bonusRate = annualRate / 2;
                        const bonusCount = years * 2;
                        bonusPayment = (bonusPrincipal * bonusRate * Math.pow(1 + bonusRate, bonusCount)) / 
                                      (Math.pow(1 + bonusRate, bonusCount) - 1);
                    }
                } else {
                    monthlyPayment = monthlyPrincipal / totalMonths;
                    bonusPayment = bonusPrincipal / (years * 2);
                }

                totalPayment = (monthlyPayment * totalMonths) + (bonusPayment * years * 2);

                // スケジュール生成（最初の12ヶ月）
                let balance = principal;
                for (let i = 1; i <= Math.min(12, totalMonths); i++) {
                    const interest = balance * monthlyRate;
                    const principalPayment = monthlyPayment - interest;
                    balance -= principalPayment;

                    schedule.push({
                        month: i,
                        payment: monthlyPayment,
                        principal: principalPayment,
                        interest: interest,
                        balance: Math.max(0, balance)
                    });
                }
            } else {
                // 元金均等返済
                const monthlyPrincipalPayment = monthlyPrincipal / totalMonths;
                let balance = principal;

                for (let i = 1; i <= Math.min(12, totalMonths); i++) {
                    const interest = balance * monthlyRate;
                    const payment = monthlyPrincipalPayment + interest;
                    balance -= monthlyPrincipalPayment;

                    if (i === 1) monthlyPayment = payment;

                    schedule.push({
                        month: i,
                        payment: payment,
                        principal: monthlyPrincipalPayment,
                        interest: interest,
                        balance: Math.max(0, balance)
                    });
                }

                if (bonusPrincipal > 0) {
                    const bonusPrincipalPayment = bonusPrincipal / (years * 2);
                    bonusPayment = bonusPrincipalPayment + (bonusPrincipal * annualRate / 2);
                }

                const totalInterest = schedule.reduce((sum, s) => sum + s.interest, 0) * (totalMonths / 12);
                totalPayment = principal + totalInterest;
            }

            const totalInterest = totalPayment - principal;
            const annualPayment = (monthlyPayment * 12) + (bonusPayment * 2);

            return {
                monthlyPayment,
                bonusPayment,
                annualPayment,
                totalPayment,
                totalInterest,
                schedule
            };
        }

        // 結果表示
        function displayResults(result) {
            document.getElementById('monthlyPayment').textContent = `${formatNumber(Math.round(result.monthlyPayment))}円`;
            document.getElementById('bonusPayment').textContent = `${formatNumber(Math.round(result.bonusPayment))}円`;
            document.getElementById('annualPayment').textContent = `${formatNumber(Math.round(result.annualPayment))}円`;
            document.getElementById('totalPayment').textContent = `${formatNumber(Math.round(result.totalPayment))}円`;
            document.getElementById('totalInterest').textContent = `${formatNumber(Math.round(result.totalInterest))}円`;
        }

        // 比較表示
        function showComparison(previous, current) {
            const comparisons = [
                { id: 'monthlyChange', prev: previous.monthlyPayment, curr: current.monthlyPayment },
                { id: 'bonusChange', prev: previous.bonusPayment, curr: current.bonusPayment },
                { id: 'annualChange', prev: previous.annualPayment, curr: current.annualPayment },
                { id: 'totalChange', prev: previous.totalPayment, curr: current.totalPayment },
                { id: 'interestChange', prev: previous.totalInterest, curr: current.totalInterest }
            ];

            comparisons.forEach(comp => {
                const element = document.getElementById(comp.id);
                const diff = comp.curr - comp.prev;
                
                if (Math.abs(diff) < 100) {
                    element.className = 'result-change change-none';
                    element.textContent = '変更なし';
                } else if (diff > 0) {
                    element.className = 'result-change change-up';
                    element.innerHTML = `↑ +${formatNumber(Math.round(diff))}円`;
                } else {
                    element.className = 'result-change change-down';
                    element.innerHTML = `↓ ${formatNumber(Math.round(diff))}円`;
                }
            });
        }

        // スケジュール生成
        function generateSchedule(result) {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';

            result.schedule.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.month}回目</td>
                    <td>${formatNumber(Math.round(row.payment))}円</td>
                    <td>${formatNumber(Math.round(row.principal))}円</td>
                    <td>${formatNumber(Math.round(row.interest))}円</td>
                    <td>${formatNumber(Math.round(row.balance))}円</td>
                `;
                tbody.appendChild(tr);
            });

            // 省略行
            if (result.schedule.length > 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td colspan="5" style="text-align: center; padding: 20px; color: var(--text-muted);">
                        ・・・ 以降省略 ・・・
                    </td>
                `;
                tbody.appendChild(tr);
            }
        }

        // スケジュール表示切替
        function toggleSchedule() {
            const wrapper = document.getElementById('scheduleWrapper');
            const toggleText = document.getElementById('scheduleToggleText');
            
            if (wrapper.style.display === 'block') {
                wrapper.style.display = 'none';
                toggleText.textContent = '返済スケジュールを表示';
            } else {
                wrapper.style.display = 'block';
                toggleText.textContent = '返済スケジュールを非表示';
            }
        }

        // ヘルプ表示
        function showHelp() {
            const modal = document.getElementById('helpModal');
            modal.style.display = 'flex';
        }

        // ヘルプを閉じる
        function closeHelp() {
            const modal = document.getElementById('helpModal');
            modal.style.display = 'none';
        }

        // 数値フォーマット
        function formatNumber(num) {
            return num.toLocaleString('ja-JP');
        }

        // モーダル外クリックで閉じる
        document.getElementById('helpModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeHelp();
            }
        });
    </script>
</body>
</html>
